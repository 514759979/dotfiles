#!/bin/sh

export LANG="en_US.UTF-8"
export LC_TIME="C"
[ -n "$USERNAME" ] || export USERNAME="goreliu"
[ -n "$SHELL" ] || export SHELL="/bin/zsh"

if [ "$OSTYPE" = "msys" ]; then
    chcp 437 &>/dev/nul
    export TERM="xterm"
    export PATH="/usr/bin:/mingw64/bin:$PATH"
    export MSYS="winsymlinks:lnk"

    alias adb="/c/mine/app/android-platform-tools/adb.exe"
    alias ahk="/c/mine/app/AutoHotkey/AutoHotkey.exe"
    alias ahk2exe="/c/mine/app/AutoHotkey/Compiler/Ahk2Exe.exe"
    alias fastboot="/c/mine/app/android-platform-tools/fastboot.exe"
    alias mencoder="/c/mine/app/AMT/AMT_Binaries/mplayer-svn-37569/mencoder.exe"
    alias mplayer="HOME=/t winpty /c/mine/app/AMT/AMT_Binaries/mplayer-svn-37569/AMT-MPlayer.exe -nofontconfig"
    alias ffmpeg="/c/mine/app/Audacity/ffmpeg/ffmpeg"
    alias mpv="winpty /c/mine/app/mpv/mpv.exe"
    alias np="/c/mine/app/notepad++/notepad++"
    alias pandoc="/c/mine/app/Pandoc/pandoc"
    alias wkhtmltoimage="/c/mine/app/wkhtmltopdf/bin/wkhtmltoimage"
    alias wkhtmltopdf="/c/mine/app/wkhtmltopdf/bin/wkhtmltopdf"
    alias ifconfig='ipconfig | iconv -f gbk -t utf-8'
    alias vb='(/c/Program\ Files/Oracle/VirtualBox/VirtualBox &)'
    alias vm='/c/Program\ Files/Oracle/VirtualBox/VBoxManage'
    alias hostname='/usr/lib/gettext/hostname'
    alias tc='(/c/mine/app/totalcmd/TOTALCMD.EXE $PWD &)'
    alias tl='tasklist'
    alias psa='ps -W'
    alias flve='/c/mine/app/FLV_Extract/FLVExtractCL.exe'
    alias mgcc='/mingw64/bin/gcc'
    alias mg++='/mingw64/bin/g++'
    alias mi='mintty'

    alias z='winpty powershell -NoLogo'
    alias cl='cat >/dev/clipboard'
    alias vmup='vm startvm archlinux --type headless'
    alias vmdown='vm controlvm archlinux savestate'
    alias vmpause='vm controlvm archlinux pasue'
    alias vmresume='vm controlvm archlinux resume'
    alias vmhalt='vm controlvm archlinux poweroff'
    alias vmlist='vm list vms; echo --RUNNING--; vm list runningvms'
    alias vcl='vs cat /tmp/.clipboard 2>/dev/null | cl'

    vst() {
        ssh -t $USERNAME@127.0.0.1 -p 50247 "$@"
    }

    vs() {
        [ "$1" = "-t" ] && {
            shift
            vst "$@"
            return
        }

        local args
        [ "$#" -ge 1 ] && {
            args="MYSSH=1 bash -lc \"$@\""
        }

        ssh $USERNAME@127.0.0.1 -p 50247 "$args"

        ret=$?

        [ $ret -eq 255 -a $# -eq 0 ] && {
            /c/Program\ Files/Oracle/VirtualBox/VBoxManage \
                startvm archlinux --type headless

            while true; do
                ssh $USERNAME@127.0.0.1 -p 50247 "$args"
                ret=$?
                [ $ret -eq 0 ] && {
                    break
                }
                sleep 1
            done
        }

        return $ret
    }

    vcp() {
        scp -r "$@" $USERNAME@127.0.0.1:~/
    }

    sudo() {
        cygstart --action=runas "$@"
    }

    srun() {
        sudo powershell -NoLogo -c "$@;pause"
    }

    disma() {
        srun Dism.exe /Online /Cleanup-Image /AnalyzeComponentStore
    }

    dismc() {
        srun Dism.exe /online /Cleanup-Image /StartComponentCleanup /ResetBase
    }

    tk() {
        taskkill //f //im "$1.exe" 2>&1
    }

    tmux() {
        /usr/bin/tmux "$@"

        pgrep tmux >/dev/null || rm /tmp/tmux-*/default 2>/dev/null
    
        # [ $# -eq 0 ] && rm /tmp/tmux-*/default 2>/dev/null
    }

    # note
    # enable ps1
    # srun Set-ExecutionPolicy RemoteSigned
else
    alias smvb="sudo mount.vboxsf -o uid=1000,gid=1000,rw,dmode=700,fmode=600"
    alias cl='cat >/tmp/.clipboard'
    alias sm='sudo mount'
    alias u='sudo umount'
    alias se='sudo systemctl'
    alias czip="export UNZIP='-O CP936'"
    alias psa='ps aux'

    #zcd() {
    #    cd ~/.avfs$PWD/$@#
    #}

    #zback() {
    #    cd $(pwd|sed -e 's|^.*\.avfs||g' -e 's|/[^/]*#$||g')
    #}

    vmpath () {
        src="$1"
        [ -n "$src" ] || src="$PWD"
        echo "scp -r 127.0.0.1:`readlink -f $src` ."
    }
fi

export PATH="$PATH:$HOME/.bin"
export EDITOR=vim
export PAGER='less -irf'
export GREP_COLOR='40;33;01'
eval `dircolors $HOME/.dir_colors`

# man color
export LESS_TERMCAP_mb=$'\E[01;31m'
export LESS_TERMCAP_md=$'\E[01;31m'
export LESS_TERMCAP_me=$'\E[0m'
export LESS_TERMCAP_se=$'\E[0m'
export LESS_TERMCAP_so=$'\E[01;44;33m'
export LESS_TERMCAP_ue=$'\E[0m'
export LESS_TERMCAP_us=$'\E[01;32m'

st() {
    ($@ &>/dev/null &)
}

imgresize() {
    gm mogrify -resize $1x$2 $3
}

cry() {
    if [ "t$1" = "t-d" ]; then
        openssl enc -aes-256-cbc -d -in $2 -out $3
    else
        openssl enc -aes-256-cbc -e -in $1 -out $2
    fi
}

c() {
    cd $1
    ls -F --color
}

# atool begin
file_7z='\.rar\b|\.deb\b|\.iso\b'

al() {
    if echo $* |grep -Pi $file_7z >/dev/null; then
        als $* -F 7z
    else
        als $*
    fi
}

a() {
    if echo $* |grep -Pi $file_7z >/dev/null; then
        apack $* -F 7z
    else
        apack $*
    fi
}

au() {
    if echo $* |grep -Pi $file_7z >/dev/null; then
        arepack $* -F 7z
    else
        arepack $*
    fi
}

x() {
    if echo $* |grep -Pi $file_7z >/dev/null; then
        aunpack $* -F 7z
    else
        aunpack $*
    fi
}

# atool end

#mcat() {
#    markdown_py $1 -f /tmp/.html
#    w3m /tmp/.html
#    rm /tmp/.html
#}

findx() {
    find -print0 | xargs -0 $@
}

calc() {
    zmodload zsh/mathfunc 2>/dev/null
    echo $[$*]
}

gr() {
    grep --color "$*" -r .
}

b() {
    if [ $# = 0 ]; then
        cd ..
    else
        go_dir='.'
        for i in {1..$1}; do
            go_dir=$go_dir/..
        done
        cd $go_dir
    fi

    ls -F --color
}

cwi() {
    cat `which $1`
}

vwi() {
    vim `which $1`
}

#mm() {
#    echo "$2" | mail -s "$1" $3 $4 ly50247@126.com
#}

ba() {
    o "http://www.baidu.com/s?wd=$*"
}

ac() {
    if [ $# = 1 ]; then
        awk '{print $'$1'}' $2
    elif [ $# = 2 ]; then
        awk -F$2 '{print $'$1'}' $3
    elif [ $# = 0 ]; then
        awk '{print $1}' $1
    fi
}

fordo() {
    cmd=$1
    shift
    for i in $*; do
        eval $cmd $i
    done
}

n2dec() {
    echo $[$2#$1]
}

dec2n() {
    echo "obase=$2;$1" | bc
}

0x() {
    n2dec $1 16
}

0b() {
    n2dec $1 2
}

0o() {
    n2dec $1 8
}

p16() {
    dec2n $1 16
}

p8() {
    dec2n $1 8
}

p2() {
    dec2n $1 2 
}

lsfd() {
  [ "$#" -eq 1 ] || return 0
  ps aux | grep "$1"
  for i in $(pgrep "$1"); do
    echo "\n$i":
    ls -l --color /proc/"$i"/fd
  done
}

lsproc() {
  [ $# -eq 1 ] || return 0
  ps aux | grep "$1"
  for i in $(pgrep "$1"); do
    echo "\n$i":
    ls -l --color /proc/"$i"
  done
}

if type yaourt &>/dev/null; then
    alias p='yaourt'
    alias pi='p -S'
    alias pia='p -S --noconfirm'
    alias pli='p -U'
    alias pud='p -Syu --aur'
    alias psu='p -Su --aur'
    alias pd='p -Sw'
    alias pp='p -Rcsn'
    alias psi='p -Si'
    alias pq='p -Q'
    alias pqi='p -Qi'
    alias pqe='pacman -Qeq | sort'
    alias psl='pkgfile -l'
    alias pql='p -Ql'
    alias pso='pkgfile -v'
    alias pqo='p -Qo'
    alias pqd='p -Qdt'
    alias pqm='p -Qqm'
    alias prd='p -Rdd'
    alias pae='p -D --asexplicit'
    alias pad='p -D --asdeps'
    alias pcl='echo y"\n"y | p -Scc'
    alias pbs='p -G'
    alias pfy='sudo pkgfile -uz'

    y() {
        pacman -Ss $*
        cat ~/.cache/aurlist | grep -Pi --color=none "$*" | awk -F'  ' '{
            a=" "$2" ("$3")"
            print "\033[35;1maur/\033[36;1m" $1 "\033[32;1m" a "\033[0m"
            print "    "$5
        }'
    }

    pqii() {
        cat /var/lib/pacman/local/$1-*/install
    }

elif type pacman &>/dev/null; then
    alias p='pacman --color auto -Ss'
    alias pi='pacman --color auto -S'
    alias pia='pacman --color auto -S --noconfirm'
    alias pli='pacman --color auto -U'
    alias pud='pacman --color auto -Syu'
    alias psu='pacman --color auto -Su'
    alias pd='pacman --color auto -Sw'
    alias pp='pacman --color auto -Rcsn'
    alias psi='pacman --color auto -Si'
    alias pq='pacman --color auto -Q'
    alias pqi='pacman --color auto -Qi'
    alias pqe='pacman --color auto -Qeq | sort'
    alias psl='pkgfile -l'
    alias pql='pacman --color auto -Ql'
    alias pso='pkgfile -v'
    alias pqo='pacman --color auto -Qo'
    alias pqd='pacman --color auto -Qdt'
    alias pqm='pacman --color auto -Qqm'
    alias prd='pacman --color auto -Rdd'
    alias pae='pacman --color auto -D --asexplicit'
    alias pad='pacman --color auto -D --asdeps'
    alias pcl='echo y"\n"y | pacman --color auto -Scc'
    alias pfy='pkgfile -u'

    pqii() {
        cat /var/lib/pacman/local/$1-*/install
    }

elif type apt-cyg &>/dev/null; then
    alias p='cat /setup/*/*/setup.ini | grep ^@ | grep'
    alias pi='apt-cyg install'
    alias pp='apt-cyg remove'
    alias pud='apt-cyg upgrade'
    alias pud_bak='cygwin -gdNq'
    alias pq='apt-cyg list'
    alias pqi='apt-cyg show'
    alias psi='apt-cyg show'
    alias pqo='cygcheck -f'
    alias pso='cygcheck -p'
    alias pql='cygcheck -l'
    alias pcl='rm -rf /setup/*/x86_64/release/'
    alias pd='apt-cyg download'

elif type brew &>/dev/null; then
    alias p='brew search'
    alias pi='brew install'
    alias pp='brew uninstall'
    alias psi='brew info'
    alias pq='brew list'
    alias pql='brew list'
    alias pud='brew update'
    alias psu='brew upgrade'

elif type apt-get &>/dev/null; then
    alias p='apt-cache search'
    alias pi='apt-get install'
    alias pp='apt-get purge'
    alias pud='apt-get update;apt-get upgrade'
    alias pqd='apt-get autoremove'
    alias psu='apt-get upgrade'
    alias pcl='apt-get clean'
    alias pql='dpkg -l'

elif type emerge &>/dev/null; then
    alias p='eix'
    alias pi='sudo emerge -uDN'
    alias psu='sudo emerge -uDN world'
    alias pp='sudo emerge -c'
    alias prd='sudo emerge -C'
    alias pud='sudo emerge --sync'
    alias pd='sudo emerge -f'
    alias pql='equery f'
    alias pqo='equery b'
    alias pq='equery l'
    alias psi='emerge -pv'
    alias pli='sudo emerge -k'
fi

alias h='history'
alias l='ls -F --color'
alias lsd='l -d *(-/DN)'
alias ll='l -l --time-style=long-iso'
alias la='l -A'
alias lla='ll -A'
alias llh='ll -h'
alias g='grep'
alias rd='rmdir'
alias md='mkdir'
alias v='vim'
alias sv='sudo vim'
alias py2='python2'
alias py='python3'
alias info='info --vi-keys'
alias s='sudo'
alias hd='hexdump -C'
alias le='less -irf'
alias dh='df -hT'
alias pyweb='python_upload 8888'
alias ucat='iconv -f gb18030 -t utf-8 -c'
alias gcat='iconv -f utf-8 -t gb18030 -c'
alias u16cat='iconv -f utf-16 -t utf-8 -c'
alias dub='du -sbh'
alias dud='du --max-depth 1 -bh '
alias psg='psa|grep -v grep|grep'
alias pst='pstree'
alias mt="top -u $USERNAME"
alias ctime='time cat'
alias wi='which'
alias rpd='rm -r $PWD;cd ..'
alias rpdf='rm -rf $PWD;cd ..'
alias cpui='cat /proc/cpuinfo | grep MHz'
alias find0='find -print0'
alias xargs0='xargs -0'
alias findg='find | grep -P'
alias e='echo'
alias f='file'
alias t='cat'
alias i='git'
alias ic='ifconfig'
alias m='man'
alias q='exit'
alias vd='vimdiff'
alias wl='wc -l'
alias di='colordiff'
alias frm='free -m'
alias fm='ranger'
alias d='tree'
alias gmc='gm convert'
alias jl='ll /dev/sd*'
alias tf='tailf'
alias pb='download_source search'
alias pbg='download_source download'
alias hi='hostname -i'
alias ,='percol'
