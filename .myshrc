#!/bin/sh

export LANG="en_US.UTF-8"
export LC_TIME="C"
[ -n "$USER" ] || export USER="goreliu"
[ -n "$SHELL" ] || export SHELL="/bin/zsh"

alias h='history'
alias l='ls -F --color'
alias lsd='l -d *(-/DN)'
alias ll='l -l --time-style=long-iso'
alias la='l -A'
alias lla='ll -A'
alias llh='ll -h'
alias g='grep'
alias rd='rmdir'
alias md='mkdir -p'
alias v='vim'
alias sv='sudo vim'
alias py='python3'
alias py2='python2'
alias py3='python3'
alias info='info --vi-keys'
alias s='sudo'
alias hd='hexdump -C'
alias le='less -irf'
alias dh='df -hT'
alias pyweb='python_upload 8888' #python -m http.server 8888
alias ucat='iconv -f gb18030 -t utf-8 -c'
alias gcat='iconv -f utf-8 -t gb18030 -c'
alias u16cat='iconv -f utf-16 -t utf-8 -c'
alias dub='du -sbh'
alias dud='du --max-depth 1 -bh'
alias psa='ps aux'
alias psg='psa | grep -v grep | grep'
alias pk='pkill'
alias pk9='pkill -9'
alias ka='killall'
alias ka9='killall -9'
alias pst='pstree'
alias mt="top -u $USER"
alias ctime='time cat'
alias wi='which'
alias rpd='rm -r $PWD; cd ..'
alias rpdf='rm -rf $PWD; cd ..'
alias cpui='cat /proc/cpuinfo | grep MHz'
alias find0='find -print0'
alias xargs0='xargs -0'
alias fng='find | grep -P'
alias e='echo'
alias f='file'
alias t='cat'
alias i='git'
alias ic='ifconfig'
alias m='man'
alias q='exit'
alias vd='vimdiff'
alias wl='wc -l'
alias frm='free -m'
alias d='tree'
alias gmc='gm convert'
alias jl='ll /dev/sd*'
alias tf='tailf'
alias pb='download_source search'
alias pbg='download_source download'
alias hi='hostname -i'
alias ,='percol'
alias ua='uname -a'
alias utf8_add_bom='sed -i "1s/^/\xEF\xBB\xBF/g"'
alias a='apack'
alias au='arepack'
alias lc='lolcat'
# j k

if [ "$HOST" = "MY-PC" -o "$HOSTNAME" = "MY-PC" ]; then
    vv1() {
        for i in "$@"; do
            cmd=$cmd' "'$i'"'
        done

        NEWPWD="$PWD"

        [ "$NEWPWD" = "/home/goreliu" ] && {
            NEWPWD="/mnt/c/Users/goreliu/AppData/Local/lxss/home/goreliu"
        }

        echo -n '!^0!'"cd \"$NEWPWD\";$cmd"'!$$!' \
            > /mnt/c/Users/goreliu/AppData/Local/Temp/run_input/input.txt
        unset cmd
    }

    vv2() {
        for i in "$@"; do
            cmd=$cmd' "'$i'"'
        done

        NEWPWD="$PWD"

        [ "$NEWPWD" = "/home/goreliu" ] && {
            NEWPWD="/mnt/c/Users/goreliu/AppData/Local/lxss/home/goreliu"
        }

        echo -n '!^1!'"cd \"$NEWPWD\";$cmd"'!$$!' \
            > /mnt/c/Users/goreliu/AppData/Local/Temp/run_input/input.txt
        unset cmd

        touch /mnt/c/Users/goreliu/AppData/Local/Temp/run_output/wait
        while [ -e /mnt/c/Users/goreliu/AppData/Local/Temp/run_output/wait ]; do
            sleep 0.01
        done

        cat /mnt/c/Users/goreliu/AppData/Local/Temp/run_output/output.txt
    }

    vv3() {
        for i in "$@"; do
            cmd=$cmd' "'$i'"'
        done

        NEWPWD="$PWD"

        [ "$NEWPWD" = "/home/goreliu" ] && {
            NEWPWD="/mnt/c/Users/goreliu/AppData/Local/lxss/home/goreliu"
        }

        echo -n '!^1!'"cd \"$NEWPWD\";$cmd"'!$$!' \
            > /mnt/c/Users/goreliu/AppData/Local/Temp/run_input/input.txt
        unset cmd

        touch /mnt/c/Users/goreliu/AppData/Local/Temp/run_output/wait
        (watch_file /mnt/c/Users/goreliu/AppData/Local/Temp/run_output/wait &)

        tail -s 0.5 \
            --pid $(cat /mnt/c/Users/goreliu/AppData/Local/Temp/run_output/wait.pid) \
            -f /mnt/c/Users/goreliu/AppData/Local/Temp/run_output/output.txt
    }

    alias u="vv2"
    alias ahk="vv1 /mine/app/AutoHotkey/AutoHotkeyU32.exe"
    alias ahk64="vv1 /mine/app/AutoHotkey/AutoHotkeyU64.exe"
    alias np="vv1 /mine/app/notepad++/notepad++.exe"
    alias mi='vv1 mintty'
    alias fm='tc'
    alias di="vv1 /mine/app/WinMerge/WinMergeU.exe"
    alias mpv="vv1 winpty /mine/app/mpv/mpv.exe"
    alias flve='vv2 /mine/app/FLV_Extract/FLVExtractCL.exe'
    alias ipconfig='vv2 ipconfig'
    alias tl='vv2 tasklist'
    alias ping='vv3 ping'
    alias sync_file='vv2 ~/.bin/sync_file'
    alias hi='ifconfig 2>/dev/null | grep broadcast | cut -d" " -f10'

    #alias vm='vv2 /mnt/c/Program\\ Files/Oracle/VirtualBox/VBoxManage.exe'
    #alias vmup='vm startvm archlinux --type headless'
    #alias vmdown='vm controlvm archlinux savestate'
    #alias vmpause='vm controlvm archlinux pasue'
    #alias vmresume='vm controlvm archlinux resume'
    #alias vmhalt='vm controlvm archlinux poweroff'
    #alias vmlist='vm list vms; echo --RUNNING--; vm list runningvms'
    #alias vst="ssh -t $USER@127.0.0.1 -p 50247"

    #vs() {
    #    [ "$1" = "-t" ] && {
    #        shift
    #        vst "$@"
    #        return
    #    }

    #    local args
    #    [ "$#" -ge 1 ] && {
    #        args="MYSSH=1 bash -lc \"$@\""
    #    }

    #    ssh $USER@127.0.0.1 -p 50247 "$args"

    #    ret=$?

    #    [ $ret -eq 255 -a $# -eq 0 ] && {
    #        vv2 /mnt/c/Program\\ Files/Oracle/VirtualBox/VBoxManage \
    #            startvm archlinux --type headless

    #        while true; do
    #            ssh $USER@127.0.0.1 -p 50247 "$args"
    #            ret=$?
    #            [ $ret -eq 0 ] && {
    #                break
    #            }
    #            sleep 1
    #        done
    #    }
    #
    #    return $ret
    #}

    tc() {
        NEWPWD="$(readlink -f $PWD)"

        [ "$NEWPWD" = "/home/goreliu" ] && {
            NEWPWD="/mnt/c/Users/goreliu/AppData/Local/lxss/home/goreliu"
        }

        vv1 /mine/app/totalcmd/TOTALCMD.EXE "$NEWPWD"
    }

    cl() {
        cat >/mnt/c/Users/goreliu/AppData/Local/Temp/run_output/clip
        vv1 'cat /mnt/c/Users/goreliu/AppData/Local/Temp/run_output/clip > /dev/clipboard'
    }

    wsudo() {
        vv1 cygstart --action=runas "$@"
    }

    srun() {
        wsudo powershell -NoLogo -c "\"$@;pause\""
    }

    disma() {
        srun Dism.exe /Online /Cleanup-Image /AnalyzeComponentStore
    }

    dismc() {
        srun Dism.exe /online /Cleanup-Image /StartComponentCleanup /ResetBase
    }

    tk() {
        vv2 taskkill //f //im "$1.exe"
    }

    [ -n "$PASSDIR" ] && {
        cd "$PASSDIR"
    }

    [ -z "$TMUX" ] && {
        if [ -n "$PASSDIR" ]; then
            NEWPASSDIR="$PASSDIR"
            unset PASSDIR
            tmux new-window -c "$NEWPASSDIR" \; a &>/dev/null || exec tmux
        else
            tmux a &>/dev/null || exec tmux
        fi
        exit
    }

    # note
    # enable ps1
    # srun Set-ExecutionPolicy RemoteSigned

elif [ "$OSTYPE" = "msys" ]; then
    chcp 437 &>/dev/null
    export PATH="/usr/bin:/mingw64/bin:$PATH"
    export MSYS="winsymlinks:lnk"

    alias ifconfig='ipconfig | iconv -f gbk -t utf-8 -c'
    alias hostname='/usr/lib/gettext/hostname'
    alias cl='cat >/dev/clipboard'

elif [ "$OSTYPE" = "linux-android" -o "$OSTYPE" = "linux-androideabi" ]; then
    export SHELL="/data/data/com.termux/files/usr/bin/zsh"
    alias o="bash ~/.bin/o"
    alias n="bash ~/.bin/n"
    alias cg="bash ~/.bin/cg"
    alias vg="bash ~/.bin/vg"
    alias renamex="bash ~/.bin/renamex"
    alias pb="bash ~/.bin/download_source search"
    alias pbg="bash ~/.bin/download_source download"
    alias search_cpu="bash ~/.bin/search_cpu"
    alias dh="df 2>/dev/null"
    alias frm="free -m | sed 's/ \+/  /g'"
    alias pkill="busybox pkill"

    precmd() {
        PROMPT=$(echo "${CYAN}goreliu@${GREEN}my-phone:$RED%(?..[%?]:)$WHITE%~\n$WHITE\$$FINISH ")
    }

else
    #alias smvb="sudo mount.vboxsf -o uid=1000,gid=1000,rw,dmode=700,fmode=600"
    #alias sm='sudo mount'
    #alias u='sudo umount'
    #alias czip="export UNZIP='-O CP936'"
    alias se='sudo systemctl'
    alias fm='ranger'
    alias di='colordiff'
fi

export PATH="$PATH:$HOME/.bin"
export EDITOR=vim
export PAGER='less -irf'
export GREP_COLOR='40;33;01'
eval `dircolors $HOME/.dir_colors`

# man color
export LESS_TERMCAP_mb=$'\E[01;31m'
export LESS_TERMCAP_md=$'\E[01;31m'
export LESS_TERMCAP_me=$'\E[0m'
export LESS_TERMCAP_se=$'\E[0m'
export LESS_TERMCAP_so=$'\E[01;44;33m'
export LESS_TERMCAP_ue=$'\E[0m'
export LESS_TERMCAP_us=$'\E[01;32m'

imgresize() {
    gm mogrify -resize $1x$2 $3
}

cry() {
    if [ "t$1" = "t-d" ]; then
        openssl enc -aes-256-cbc -d -in $2 -out $3
    else
        openssl enc -aes-256-cbc -e -in $1 -out $2
    fi
}

c() {
    cd $1
    ls -F --color
}

al() {
    als "$@" || 7z l "$@"
}

x() {
    aunpack "$@" || aunpack "$@" -F 7z
}

findx() {
    find -print0 | xargs -0 "$@"
}

calc() {
    zmodload zsh/mathfunc 2>/dev/null
    echo $[$*]
}

gr() {
    grep --color "$*" -r .
}

b() {
    if [ $# = 0 ]; then
        cd ..
    else
        go_dir='.'
        for i in {1..$1}; do
            go_dir=$go_dir/..
        done
        cd $go_dir
    fi

    ls -F --color
}

cwi() {
    cat "`which $1`"
}

vwi() {
    vim "`which $1`"
}

ac() {
    if [ $# = 1 ]; then
        awk '{print $'$1'}' $2
    elif [ $# = 2 ]; then
        awk -F$2 '{print $'$1'}' $3
    elif [ $# = 0 ]; then
        awk '{print $1}' $1
    fi
}

n2dec() {
    echo "$[$2#$1]"
}

dec2n() {
    echo "obase=$2;$1" | bc
}

0x() {
    n2dec $1 16
}

0b() {
    n2dec $1 2
}

0o() {
    n2dec $1 8
}

p16() {
    dec2n $1 16
}

p8() {
    dec2n $1 8
}

p2() {
    dec2n $1 2 
}

exaac() {
    ffmpeg -i $1 -vn -sn -c:a copy -y -map 0:a:0 $1.aac
}

top_history() {
    num=20
    [ -n "$1" ] && num="$1"
    history 1 \
        | awk '{CMD[$2]++;count++;}END \
            { for (a in CMD)print CMD[a] " " CMD[a]/count*100 "% " a;}' \
        | column -c3 -s " " -t | sort -nr | nl | head -n"$num"
}

if type yaourt &>/dev/null; then
    alias p='yaourt'
    alias pi='p -S'
    alias pia='p -S --noconfirm'
    alias pli='p -U'
    alias pud='p -Syu --aur'
    alias psu='p -Su --aur'
    alias pd='p -Sw'
    alias pp='p -Rcsn'
    alias psi='p -Si'
    alias pq='p -Q'
    alias pqi='p -Qi'
    alias pqe='pacman -Qeq | sort'
    alias psl='pkgfile -l'
    alias pql='p -Ql'
    alias pso='pkgfile -v'
    alias pqo='p -Qo'
    alias pqd='p -Qdt'
    alias pqm='p -Qqm'
    alias prd='p -Rdd'
    alias pae='p -D --asexplicit'
    alias pad='p -D --asdeps'
    alias pcl='echo y"\n"y | p -Scc'
    alias pbs='p -G'
    alias pfy='sudo pkgfile -uz'

    y() {
        pacman -Ss $*
        cat ~/.cache/aurlist | grep -Pi --color=none "$*" | awk -F'  ' '{
            a=" "$2" ("$3")"
            print "\033[35;1maur/\033[36;1m" $1 "\033[32;1m" a "\033[0m"
            print "    "$5
        }'
    }

    pqii() {
        cat /var/lib/pacman/local/$1-*/install
    }

elif type pacman &>/dev/null; then
    alias p='pacman --color auto -Ss'
    alias pi='pacman --color auto -S'
    alias pia='pacman --color auto -S --noconfirm'
    alias pli='pacman --color auto -U'
    alias pud='pacman --color auto -Syu'
    alias psu='pacman --color auto -Su'
    alias pd='pacman --color auto -Sw'
    alias pp='pacman --color auto -Rcsn'
    alias psi='pacman --color auto -Si'
    alias pq='pacman --color auto -Q'
    alias pqi='pacman --color auto -Qi'
    alias pqe='pacman --color auto -Qeq | sort'
    alias psl='pkgfile -l'
    alias pql='pacman --color auto -Ql'
    alias pso='pkgfile -v'
    alias pqo='pacman --color auto -Qo'
    alias pqd='pacman --color auto -Qdt'
    alias pqm='pacman --color auto -Qqm'
    alias prd='pacman --color auto -Rdd'
    alias pae='pacman --color auto -D --asexplicit'
    alias pad='pacman --color auto -D --asdeps'
    alias pcl='echo y"\n"y | pacman --color auto -Scc'
    alias pfy='pkgfile -u'
    alias pl='p'

    pqii() {
        cat /var/lib/pacman/local/$1-*/install
    }

elif type apt-get &>/dev/null; then
    alias p='apt-cache search'
    alias y='apt list 2>/dev/null | grep'
    alias pi='sudo apt-get install'
    alias pia='sudo apt-get install'
    alias pp='sudo apt-get purge'
    alias pud='sudo apt-get update; sudo apt-get upgrade'
    alias psu='sudo apt-get upgrade'
    alias pqd='sudo apt-get autoremove'
    alias pcl='sudo apt-get clean'
    alias pql='dpkg -L'
    alias pq='apt list --installed'
    alias pqe='apt list --installed 2>/dev/null | grep -Fv ",automatic"'
    alias pqm='apt list --installed 2>/dev/null | grep -F ",local"'
    alias psi='apt show'
    alias pqi='dpkg -s'
    alias pqo='dpkg -S'
    alias pli='dpkg -i'
    alias pl='apt list'
    alias pae='sudo apt-get install'
    alias pad='sudo apt-get markauto'
    alias pd='sudo pi -d'
fi
